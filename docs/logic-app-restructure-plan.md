# 逻辑链应用重构方案

## 文档概述

本文档描述了对逻辑链应用的完整重构方案，包括节点类型、关系类型、状态系统、传播规则和分析算法的设计。

---

## 一、节点类型定义

### 1.1 节点类型总览

应用包含六种节点类型：

| 节点类型 | 英文标识 | 定义 | 颜色 |
|---------|---------|------|------|
| 目标 | goal | 期望达成的终态 | 红色 |
| 行动 | action | 可执行的操作 | 绿色 |
| 事实 | fact | 已观察到或已确认的信息 | 蓝色 |
| 假设 | assumption | 未经验证的信息 | 黄色 |
| 约束 | constraint | 必须满足的条件 | 紫色 |
| 结论 | conclusion | 从其他节点推导出的命题 | 青色 |

### 1.2 各节点类型详细定义

#### 目标节点 (Goal)

```
定义：期望达成的终态
颜色：红色
图标：旗帜或靶心

基础状态选项：
- achieved（已达成）：目标已经实现
- notAchieved（未达成）：目标还没实现

默认状态：notAchieved

用户可设置字段：
- 名称（必填）
- 描述（选填）
- 基础状态
- 影响力（0-100%，默认50%）

示例：
- 活下去
- 和NASA建立联系
```

#### 行动节点 (Action)

```
定义：可执行的操作
颜色：绿色
图标：闪电或播放按钮

基础状态选项：
- success（成功）：执行了且达到预期效果
- failed（失败）：执行了但没达到预期效果
- inProgress（进行中）：正在执行
- pending（待执行）：还没开始

默认状态：pending

用户可设置字段：
- 名称（必填）
- 描述（选填）
- 基础状态
- 影响力（0-100%，默认50%）

示例：
- 种植作物
- 修复通讯
- 燃烧制水
```

#### 事实节点 (Fact)

```
定义：已观察到或已确认的信息
颜色：蓝色
图标：对勾或文档

基础状态选项：
- confirmed（确认）：这是真的
- denied（否定）：这是假的（情况已改变）
- uncertain（存疑）：还不确定

默认状态：confirmed

用户可设置字段：
- 名称（必填）
- 描述（选填）
- 基础状态
- 影响力（0-100%，默认50%）

示例：
- 补给缺口
- 火星死土
- 植物学家
```

#### 假设节点 (Assumption)

```
定义：未经验证的信息
颜色：黄色
图标：问号或灯泡

基础状态选项：
- positive（当作真的）：在规划中假设它成立
- negative（当作假的）：在规划中假设它不成立
- uncertain（不确定）：还没决定怎么处理

默认状态：uncertain

用户可设置字段：
- 名称（必填）
- 描述（选填）
- 基础状态
- 置信度（0-100%，默认50%，表示认为它为真的概率）
- 影响力（0-100%，默认50%）

示例：
- NASA在监听
- 不会爆炸
```

#### 约束节点 (Constraint)

```
定义：必须满足的条件
颜色：紫色
图标：锁或条件符号

基础状态选项：
- satisfied（已满足）：条件已达成
- unsatisfied（未满足）：条件还没达成

默认状态：unsatisfied

用户可设置字段：
- 名称（必填）
- 描述（选填）
- 基础状态
- 影响力（0-100%，默认50%）
- 自动更新开关（是否由行动状态自动计算，默认开启）

示例：
- 热量需求
- 氧气充足
- 水源需求
```

#### 结论节点 (Conclusion)

```
定义：从其他节点推导出的命题
颜色：青色
图标：推导符号或箭头

基础状态选项：
- established（成立）：根据证据，结论为真
- notEstablished（不成立）：根据证据，结论为假
- pending（待定）：证据不足

默认状态：pending

用户可设置字段：
- 名称（必填）
- 描述（选填）
- 基础状态
- 影响力（0-100%，默认50%）
- 自动更新开关（是否由导致关系自动计算，默认开启）

示例：
- 没有救援
- 有通讯能力
```

---

## 二、关系类型定义

### 2.1 关系类型总览

应用包含六种关系类型：

| 关系类型 | 英文标识 | 符号 | 定义 | 颜色 |
|---------|---------|------|------|------|
| 依赖 | depends | ← | B依赖A，没有A就没有B | 灰色 |
| 促成 | supports | → | A促成B，A让B更容易实现 | 绿色 |
| 阻碍 | hinders | ⊣ | A阻碍B，A让B更难实现 | 红色 |
| 实现 | achieves | ⊢ | 行动A可以满足约束/目标B | 蓝色 |
| 导致 | causes | ⇒ | A发生会引起B发生 | 橙色 |
| 矛盾 | contradicts | ⊥ | A和B不能同时为真 | 黑色虚线 |

### 2.2 各关系类型详细定义

#### 依赖关系 (Depends)

```
符号：←
方向：A ← B，读作"B依赖A"
颜色：灰色
线型：实线

定义：
B要成立/成功，必须先有A。A是B的必要条件。

有效连接：
- 约束 ← 目标（目标依赖约束）
- 约束 ← 行动（行动依赖约束）
- 假设 ← 目标（目标依赖假设成立）
- 事实 ← 行动（行动依赖某事实条件）
- 约束 ← 约束（约束之间的依赖）

计算规则：
若A的状态为否定态或中间态，则B的计算状态标记为"受阻"。

示例：
- 热量需求 ← 活下去（活下去依赖热量需求）
- 水源需求 ← 种植作物（种植作物依赖水源需求）
- NASA在监听 ← 和NASA建立联系
```

#### 促成关系 (Supports)

```
符号：→
方向：A → B，读作"A促成B"
颜色：绿色
线型：实线

定义：
A成立会帮助B成立。正向概率影响，但不是必要条件。

有效连接：
- 事实 → 行动（事实支持行动可行性）
- 事实 → 目标（事实支持目标达成）
- 假设 → 行动（假设若成立则支持行动）
- 目标 → 目标（子目标促成父目标）
- 事实 → 约束（事实有助于约束满足）

计算规则：
A的状态为肯定态时，B的可行性得分增加。
增加值 = A的影响力 × A的状态系数

示例：
- 植物学家 → 种植作物
- 氧合机 → 氧气充足
- 和NASA建立联系 → 活下去
```

#### 阻碍关系 (Hinders)

```
符号：⊣
方向：A ⊣ B，读作"A阻碍B"
颜色：红色
线型：实线（建议用T型箭头）

定义：
A成立会妨碍B成立。负向概率影响，但不是完全否定。

有效连接：
- 事实 ⊣ 行动（事实阻碍行动）
- 事实 ⊣ 目标（事实阻碍目标）
- 事实 ⊣ 约束（事实阻碍约束满足）
- 结论 ⊣ 目标（结论阻碍目标）

计算规则：
A的状态为肯定态时，B的可行性得分减少。
减少值 = A的影响力 × A的状态系数

示例：
- 火星死土 ⊣ 种植作物
- 补给缺口 ⊣ 热量需求
- 没有救援 ⊣ 活下去
```

#### 实现关系 (Achieves)

```
符号：⊢
方向：A ⊢ B，读作"A实现B"
颜色：蓝色
线型：实线

定义：
行动A可以满足约束B或达成目标B。

有效连接：
- 行动 ⊢ 约束（行动满足约束）
- 行动 ⊢ 目标（行动达成目标）

计算规则：
若A的状态为"成功"，且B开启了自动更新，则B的状态变为"已满足"/"已达成"。
若有多个行动实现同一约束，任一成功即可（OR语义）。

示例：
- 种植作物 ⊢ 热量需求
- 燃烧制水 ⊢ 水源需求
- 修复通讯 ⊢ 和NASA建立联系
```

#### 导致关系 (Causes)

```
符号：⇒
方向：A ⇒ B，读作"A导致B"
颜色：橙色
线型：实线

定义：
A发生会引起B发生。因果关系。

有效连接：
- 事实 ⇒ 结论（事实导致结论）
- 行动 ⇒ 结论（行动导致结论）
- 结论 ⇒ 结论（结论链式传递）

计算规则：
若A的状态为肯定态，且B开启了自动更新，则B的状态变为肯定态。

示例：
- 没有通讯 ⇒ 没有救援
- 修复通讯 ⇒ 有通讯能力
```

#### 矛盾关系 (Contradicts)

```
符号：⊥
方向：A ⊥ B，无方向（对称关系）
颜色：黑色
线型：虚线

定义：
A和B不能同时为真。

有效连接：
- 任意节点 ⊥ 任意节点（只要语义上互斥）

计算规则：
若A和B的状态同时为肯定态，则两者都标记为"冲突"。
系统不自动改变任何一方的状态，而是提示用户处理冲突。

示例：
- 有通讯能力 ⊥ 没有通讯
```

---

## 三、状态系统设计

### 3.1 基础状态与计算状态

系统区分两类状态：

```
基础状态：
- 由用户手动设置
- 或由系统根据传播规则自动更新（如果用户开启了自动更新）
- 是节点的核心状态

计算状态：
- 完全由系统计算
- 用户不能直接设置
- 用于辅助分析和显示
```

### 3.2 各类型节点的基础状态

```
目标节点基础状态：
- achieved（已达成）
- notAchieved（未达成）

行动节点基础状态：
- success（成功）
- failed（失败）
- inProgress（进行中）
- pending（待执行）

事实节点基础状态：
- confirmed（确认）
- denied（否定）
- uncertain（存疑）

假设节点基础状态：
- positive（当作真的）
- negative（当作假的）
- uncertain（不确定）

约束节点基础状态：
- satisfied（已满足）
- unsatisfied（未满足）

结论节点基础状态：
- established（成立）
- notEstablished（不成立）
- pending（待定）
```

### 3.3 计算状态类型

```
受阻 (blocked)：
- 含义：有依赖未满足，无法推进
- 适用：目标、行动、约束
- 触发：依赖的节点状态为否定态或中间态

受威胁 (threatened)：
- 含义：阻碍因素多于促成因素
- 适用：目标、行动、约束
- 触发：可行性得分为负

冲突 (conflicted)：
- 含义：存在矛盾的状态
- 适用：所有节点
- 触发：与该节点矛盾的另一节点也是肯定态

可执行 (executable)：
- 含义：所有依赖都已满足，可以开始执行
- 适用：行动
- 触发：所有依赖节点状态为肯定态

可达成 (achievable)：
- 含义：存在可行路径达成目标
- 适用：目标
- 触发：所有依赖节点状态为肯定态，或有可行的实现路径
```

### 3.4 状态系数映射

用于可行性计算时，将基础状态转换为数值系数：

```
目标节点：
- achieved → 1.0
- notAchieved → 0.0

行动节点：
- success → 1.0
- failed → 0.0
- inProgress → 0.5
- pending → 0.0

事实节点：
- confirmed → 1.0
- denied → 0.0
- uncertain → 0.5

假设节点（特殊处理）：
- positive → 置信度值（如0.8）
- negative → 0.0
- uncertain → 置信度值 × 0.5

约束节点：
- satisfied → 1.0
- unsatisfied → 0.0

结论节点：
- established → 1.0
- notEstablished → 0.0
- pending → 0.5
```

---

## 四、状态传播规则

### 4.1 传播触发时机

```
触发场景：
1. 用户修改任何节点的基础状态时
2. 用户添加或删除节点时
3. 用户添加或删除关系时
4. 用户点击"刷新分析"按钮时
```

### 4.2 传播执行顺序

```
步骤1：循环依赖检测
- 对图进行拓扑排序
- 如果检测到环，标记涉及的节点为"循环依赖错误"
- 提示用户修正

步骤2：重置计算状态
- 清除所有节点的计算状态（blocked、threatened、conflicted等）
- 保留用户设置的基础状态

步骤3：导致关系传播
- 按拓扑顺序遍历节点
- 对于每条"导致"关系 A ⇒ B：
  - 如果A的基础状态为肯定态
  - 且B开启了自动更新
  - 则将B的基础状态设为肯定态

步骤4：实现关系传播
- 对于每条"实现"关系 A ⊢ B：
  - 如果A的基础状态为"success"
  - 且B开启了自动更新
  - 则将B的基础状态设为"satisfied"或"achieved"

步骤5：矛盾关系检测
- 对于每条"矛盾"关系 A ⊥ B：
  - 如果A和B的基础状态都是肯定态
  - 则将两者的计算状态都标记为"conflicted"
  - 记录冲突原因

步骤6：依赖关系检查
- 对于每条"依赖"关系 A ← B（B依赖A）：
  - 如果A的基础状态为否定态或中间态
  - 则将B的计算状态标记为"blocked"
  - 记录受阻原因为A

步骤7：可行性评分计算
- 对每个目标/行动/约束节点计算可行性得分
- 根据得分设置计算状态（threatened或正常）
```

### 4.3 传播规则详细说明

#### 规则1：导致关系传播

```
条件：
- 存在关系 A --导致--> B
- A的基础状态为肯定态（confirmed/success/satisfied/established/positive）
- B的"自动更新"开关为开启

动作：
- 将B的基础状态设为对应的肯定态
- 记录状态来源为"由A导致"

示例：
- "没有通讯"状态为confirmed
- "没有通讯 --导致--> 没有救援"
- "没有救援"自动更新为established
```

#### 规则2：实现关系传播

```
条件：
- 存在关系 A --实现--> B
- A是行动节点，B是约束或目标节点
- A的基础状态为success
- B的"自动更新"开关为开启

动作：
- 如果B是约束，将B的基础状态设为satisfied
- 如果B是目标，将B的基础状态设为achieved
- 记录状态来源为"由A实现"

多实现处理：
- 如果多个行动都实现同一约束/目标
- 任一行动成功，约束/目标即满足（OR语义）

示例：
- "燃烧制水"状态为success
- "燃烧制水 --实现--> 水源需求"
- "水源需求"自动更新为satisfied
```

#### 规则3：矛盾关系检测

```
条件：
- 存在关系 A --矛盾--> B
- A的基础状态为肯定态
- B的基础状态也为肯定态

动作：
- 将A的计算状态标记为conflicted
- 将B的计算状态标记为conflicted
- 记录冲突对为(A, B)
- 不自动改变任何一方的基础状态

重要：系统不自动解决矛盾，而是提示用户处理

示例：
- "有通讯能力"状态为established
- "没有通讯"状态为confirmed
- "有通讯能力 --矛盾--> 没有通讯"
- 两者都标记为conflicted，提示用户检查
```

#### 规则4：依赖关系检查

```
条件：
- 存在关系 A ← B（B依赖A）
- A的基础状态为否定态或中间态

动作：
- 将B的计算状态标记为blocked
- 记录受阻原因为A

多依赖处理：
- 如果B依赖多个节点
- 任一依赖未满足，B即为受阻（AND语义）
- 记录所有未满足的依赖

示例：
- "和NASA建立联系 --依赖--> NASA在监听"
- "NASA在监听"状态为uncertain
- "和NASA建立联系"标记为blocked，原因："依赖的假设'NASA在监听'尚不确定"
```

---

## 五、可行性评分算法

### 5.1 评分目的

为每个目标/行动/约束节点计算一个可行性得分，用于：
- 判断该节点是否受威胁
- 评估方案的可行性
- 排序优先级

### 5.2 评分公式

```
可行性得分 = 正向得分 - 负向得分

正向得分 = Σ(促成节点的影响力 × 促成节点的状态系数)
负向得分 = Σ(阻碍节点的影响力 × 阻碍节点的状态系数)

其中：
- 影响力：用户设置的0-1之间的值
- 状态系数：根据基础状态映射的0-1之间的值（见3.4节）
```

### 5.3 评分示例

```
评估节点：种植作物

促成因素：
- 植物学家（事实，confirmed，影响力0.7）
  贡献 = 0.7 × 1.0 = 0.7

阻碍因素：
- 火星死土（事实，confirmed，影响力0.8）
  贡献 = 0.8 × 1.0 = 0.8

可行性得分 = 0.7 - 0.8 = -0.1

结论：可行性得分为负，标记为"受威胁"
```

### 5.4 评分结果处理

```
如果可行性得分 > 0：
- 计算状态：正常（有利）
- 界面显示：绿色指示

如果可行性得分 = 0：
- 计算状态：中性
- 界面显示：灰色指示

如果可行性得分 < 0：
- 计算状态：threatened（受威胁）
- 界面显示：橙色指示

如果节点同时被标记为blocked：
- blocked优先级高于threatened
- 界面显示：黄色指示 + 受阻原因
```

---

## 六、分析模块设计

### 6.1 模块一：目标-计划树分析

#### 目的

回答用户问题："我现在该做什么？"

#### 算法步骤

```
步骤1：识别根目标

遍历所有目标节点，找出没有被其他目标通过"促成"关系指向的目标。
这些是用户的终极目标。

如果有多个根目标，让用户选择当前关注的目标，或全部分析。


步骤2：构建依赖树

对选定的根目标，递归展开所有"依赖"关系，构建依赖树。

伪代码：
function buildDependencyTree(node):
    tree = { node: node, children: [] }
    for each edge where edge.target == node and edge.type == "depends":
        child = buildDependencyTree(edge.source)
        tree.children.append(child)
    return tree


步骤3：标记节点状态

遍历依赖树，标记每个节点的当前状态：
- 已满足：基础状态为肯定态
- 未满足：基础状态为否定态或中间态
- 可实现：存在指向该节点的"实现"关系


步骤4：找出阻塞点

从根目标开始，深度优先遍历依赖树。
找出第一层状态为"未满足"的节点。
这些是当前的瓶颈。

伪代码：
function findBlockers(tree):
    if tree.node.status == "未满足":
        return [tree.node]
    blockers = []
    for child in tree.children:
        blockers.extend(findBlockers(child))
    return blockers


步骤5：找出可执行行动

对于每个阻塞点：
1. 找出所有通过"实现"关系指向它的行动节点
2. 检查这些行动的依赖是否都已满足
3. 如果是，该行动为"可立即执行"
4. 如果否，递归检查行动的依赖，找出阻塞行动的原因

伪代码：
function findExecutableActions(blocker):
    actions = findActionsAchieving(blocker)
    executable = []
    blocked = []
    for action in actions:
        if allDependenciesSatisfied(action):
            executable.append(action)
        else:
            blocked.append({
                action: action,
                blockedBy: getUnsatisfiedDependencies(action)
            })
    return { executable, blocked }


步骤6：生成执行建议

对所有可执行行动进行排序：

排序规则（优先级从高到低）：
1. 能解除最多阻塞点的行动
2. 依赖链最短的行动
3. 可行性得分最高的行动

输出格式：
{
    rootGoal: "活下去",
    currentBlockers: [
        { node: "热量需求", reason: "未满足" },
        { node: "水源需求", reason: "未满足" }
    ],
    suggestedNextAction: {
        action: "燃烧制水",
        reason: "可以满足水源需求，同时解除种植作物的阻塞",
        prerequisites: "无（所有依赖已满足）"
    },
    alternativeActions: [...],
    subsequentSteps: [
        "完成燃烧制水后，可以执行种植作物",
        "种植作物成功后，热量需求将被满足"
    ]
}
```

### 6.2 模块二：论证框架分析

#### 目的

回答用户问题："这个方案靠谱吗？"

#### 算法步骤

```
步骤1：选定评估目标

用户选择一个节点进行评估。
通常是目标节点或行动节点。


步骤2：收集正向证据

找出所有通过"促成"关系指向该节点的节点。

对每个促成节点记录：
- 节点名称
- 节点类型
- 基础状态
- 影响力
- 状态系数
- 贡献值 = 影响力 × 状态系数


步骤3：收集负向证据

找出所有通过"阻碍"关系指向该节点的节点。

对每个阻碍节点记录：
- 节点名称
- 节点类型
- 基础状态
- 影响力
- 状态系数
- 贡献值 = 影响力 × 状态系数


步骤4：检查依赖状态

找出所有该节点通过"依赖"关系依赖的节点。

对每个依赖节点记录：
- 节点名称
- 节点类型
- 基础状态
- 是否满足


步骤5：计算可行性评分

正向总分 = Σ(促成节点贡献值)
负向总分 = Σ(阻碍节点贡献值)
可行性得分 = 正向总分 - 负向总分

评估等级：
- 得分 > 0.5: 高可行性
- 得分 0 ~ 0.5: 中等可行性
- 得分 -0.5 ~ 0: 低可行性
- 得分 < -0.5: 很低可行性


步骤6：识别关键风险

风险类型及识别规则：

强阻碍风险：
- 存在事实类节点阻碍该方案
- 该事实状态为confirmed
- 风险等级 = 该事实的影响力

依赖缺口风险：
- 存在依赖节点状态为未满足
- 风险等级 = 该依赖的影响力

假设风险：
- 方案依赖状态为positive的假设
- 该假设的置信度 < 70%
- 风险等级 = (1 - 置信度) × 影响力

矛盾冲突风险：
- 方案涉及的节点存在矛盾关系
- 矛盾双方都是肯定态
- 风险等级 = 高


步骤7：生成评估报告

输出格式：
{
    targetNode: "种植作物",
    feasibilityScore: -0.1,
    feasibilityLevel: "低可行性",
    
    positiveFactors: [
        {
            node: "植物学家",
            type: "事实",
            status: "confirmed",
            importance: 0.7,
            contribution: 0.7,
            description: "我拥有植物学学位"
        }
    ],
    
    negativeFactors: [
        {
            node: "火星死土",
            type: "事实",
            status: "confirmed",
            importance: 0.8,
            contribution: 0.8,
            description: "火星土壤缺乏细菌和养分"
        }
    ],
    
    dependencies: [
        {
            node: "水源需求",
            type: "约束",
            status: "unsatisfied",
            isSatisfied: false,
            achievableBy: ["燃烧制水"]
        }
    ],
    
    risks: [
        {
            type: "强阻碍",
            source: "火星死土",
            level: "高",
            suggestion: "需要找到改造土壤的方法"
        },
        {
            type: "依赖缺口",
            source: "水源需求",
            level: "中",
            suggestion: "建议先执行燃烧制水"
        }
    ],
    
    overallAssessment: "方案可行但有较大挑战。建议先解决水源问题，同时研究如何改造火星土壤。"
}
```

### 6.3 两个模块的协作流程

```
用户操作流程：

1. 用户点击"分析"按钮
   ↓
2. 系统运行"目标-计划树分析"
   ↓
3. 显示：当前阻塞点、建议的下一步行动
   ↓
4. 用户点击某个行动节点，想了解详情
   ↓
5. 系统运行"论证框架分析"
   ↓
6. 显示：该行动的可行性评估、风险提示
   ↓
7. 用户根据分析结果，更新节点状态（如标记行动为成功）
   ↓
8. 系统自动触发状态传播
   ↓
9. 返回步骤2，循环分析
```

---

## 七、界面设计规范

### 7.1 节点编辑面板

#### 通用结构

```
┌─────────────────────────────────────┐
│ 编辑节点                        [×] │
├─────────────────────────────────────┤
│ 类型标签                            │
│                                     │
│ 名称（必填）                        │
│ [________________________]          │
│                                     │
│ 描述（选填）                        │
│ [________________________]          │
│ [________________________]          │
│                                     │
│ ─────────── 状态设置 ─────────────  │
│                                     │
│ [根据节点类型显示不同选项]          │
│                                     │
│ ─────────── 影响力 ───────────────  │
│                                     │
│ [==========○==========] 50%         │
│ 低                    高            │
│                                     │
│ ─────────── 系统分析 ─────────────  │
│                                     │
│ [显示计算状态和相关提示]            │
│                                     │
├─────────────────────────────────────┤
│              [取消]    [保存]       │
└─────────────────────────────────────┘
```

#### 各类型节点的状态区域

```
目标节点：
状态
○ 已达成    ● 未达成

行动节点：
执行状态
○ 成功  ○ 失败  ○ 进行中  ● 待执行

事实节点：
状态
● 确认  ○ 否定  ○ 存疑

假设节点：
采信状态
○ 当作真的  ○ 当作假的  ● 不确定

置信度
[=====○=====] 50%
不太可能          非常可能

约束节点：
状态
○ 已满足  ● 未满足

□ 由行动自动更新状态

结论节点：
状态
○ 成立  ○ 不成立  ● 待定

□ 由导致关系自动更新状态
```

### 7.2 分析结果面板

```
┌─────────────────────────────────────┐
│ 分析结果                        [×] │
├─────────────────────────────────────┤
│ 📍 当前目标：活下去                 │
│                                     │
│ ─────────── 阻塞点 ───────────────  │
│                                     │
│ ⚠ 热量需求 [未满足]                 │
│   可通过：种植作物                  │
│                                     │
│ ⚠ 水源需求 [未满足]                 │
│   可通过：燃烧制水                  │
│                                     │
│ ─────────── 建议行动 ─────────────  │
│                                     │
│ ▶ 燃烧制水 [可立即执行]             │
│   原因：解除水源需求阻塞            │
│   风险：依赖假设"不会爆炸"          │
│                                     │
│ ─────────── 后续步骤 ─────────────  │
│                                     │
│ 1. 执行燃烧制水                     │
│ 2. 水源需求满足后，执行种植作物     │
│ 3. 种植作物成功后，热量需求满足     │
│                                     │
└─────────────────────────────────────┘
```

### 7.3 节点状态可视化

```
基础状态显示（节点边框颜色）：
- 肯定态：绿色边框
- 否定态：红色边框
- 中间态：灰色边框

计算状态显示（节点右上角图标）：
- 受阻：🚫 黄色
- 受威胁：⚠ 橙色
- 冲突：⚡ 紫色
- 可执行：▶ 绿色

组合显示示例：
┌──────────────────┐
│ ▶               │  ← 可执行图标
│   燃烧制水       │
│                  │
└──────────────────┘
     绿色边框 ← 表示待执行状态
```

---

## 八、数据结构定义

### 8.1 节点数据结构

```
Node = {
    // 基本信息
    id: string,                    // 唯一标识
    type: NodeType,                // 节点类型
    name: string,                  // 名称（必填）
    description: string,           // 描述（选填）
    
    // 基础状态（各类型有不同的可选值）
    baseStatus: string,
    
    // 仅假设节点有
    confidence: number,            // 0-1，置信度
    
    // 所有节点都有
    importance: number,            // 0-1，影响力
    
    // 仅约束和结论节点有
    autoUpdate: boolean,           // 是否自动更新状态
    
    // 系统计算的状态（只读）
    computedStatus: {
        blocked: boolean,          // 是否受阻
        blockedBy: string[],       // 受阻原因（节点ID列表）
        threatened: boolean,       // 是否受威胁
        feasibilityScore: number,  // 可行性得分
        conflicted: boolean,       // 是否冲突
        conflictWith: string[],    // 冲突对象（节点ID列表）
        executable: boolean,       // 是否可执行（仅行动节点）
        statusSource: string       // 状态来源说明
    },
    
    // 元数据
    createdAt: timestamp,
    updatedAt: timestamp
}

NodeType = "goal" | "action" | "fact" | "assumption" | "constraint" | "conclusion"
```

### 8.2 各类型节点的 baseStatus 可选值

```
goal:
  - "achieved"（已达成）
  - "notAchieved"（未达成）
  默认值："notAchieved"

action:
  - "success"（成功）
  - "failed"（失败）
  - "inProgress"（进行中）
  - "pending"（待执行）
  默认值："pending"

fact:
  - "confirmed"（确认）
  - "denied"（否定）
  - "uncertain"（存疑）
  默认值："confirmed"

assumption:
  - "positive"（当作真的）
  - "negative"（当作假的）
  - "uncertain"（不确定）
  默认值："uncertain"

constraint:
  - "satisfied"（已满足）
  - "unsatisfied"（未满足）
  默认值："unsatisfied"

conclusion:
  - "established"（成立）
  - "notEstablished"（不成立）
  - "pending"（待定）
  默认值："pending"
```

### 8.3 关系数据结构

```
Edge = {
    id: string,                    // 唯一标识
    type: EdgeType,                // 关系类型
    sourceId: string,              // 源节点ID
    targetId: string,              // 目标节点ID
    createdAt: timestamp,
    updatedAt: timestamp
}

EdgeType = "depends" | "supports" | "hinders" | "achieves" | "causes" | "contradicts"
```

### 8.4 全局设置数据结构

```
GlobalSettings = {
    // 节点类型默认影响力
    defaultImportance: {
        goal: 0.5,
        action: 0.5,
        fact: 0.5,
        assumption: 0.5,
        constraint: 0.5,
        conclusion: 0.5
    },
    
    // 假设节点默认置信度
    defaultConfidence: 0.5,
    
    // 是否开启自动状态传播
    autoPropagate: true
}
```

---

## 九、迁移指南

### 9.1 节点类型迁移

```
原类型 → 新类型：

目标 → 目标（保持不变）
决策 → 行动（改名）
事实 → 事实（保持不变）
假设 → 假设（保持不变）
推理 → 需要用户选择：
  - 如果描述的是"必须满足的条件" → 约束
  - 如果描述的是"推导出的判断" → 结论
```

### 9.2 关系类型迁移

```
原关系 → 新关系：

前提 → 依赖（箭头方向需要反转）
  原：A --前提--> B
  新：A <--依赖-- B（即B依赖A）

支持 → 需要根据节点类型判断：
  - 如果源节点是行动，目标是约束/目标 → 实现
  - 其他情况 → 促成

反对 → 阻碍（保持方向不变）

导致 → 导致（保持不变）

矛盾 → 矛盾（保持不变）

相关 → 删除（或转为备注）
```

### 9.3 状态迁移

```
原状态 → 新状态：

真 → 根据节点类型映射为对应的肯定态
假 → 根据节点类型映射为对应的否定态
未知 → 根据节点类型映射为对应的中间态

原置信度 → 保留，仅对假设节点生效
原重要性 → 迁移为"影响力"
```

---

## 十、实现检查清单

### 10.1 数据层改动

```
□ 更新节点类型枚举
  □ 将"决策"改为"行动"
  □ 删除"推理"
  □ 添加"约束"
  □ 添加"结论"

□ 更新关系类型枚举
  □ 将"前提"改为"依赖"
  □ 将"支持"拆分为"促成"和"实现"
  □ 将"反对"改为"阻碍"
  □ 删除"相关"

□ 更新节点数据结构
  □ 添加baseStatus字段（替代原来的逻辑状态）
  □ 添加autoUpdate字段（约束和结论节点）
  □ 添加computedStatus对象
  □ 将"重要性"改为"影响力"(importance)
  □ 保留confidence字段（仅假设节点使用）

□ 编写数据迁移脚本
```

### 10.2 状态传播模块

```
□ 实现循环依赖检测算法
□ 实现拓扑排序算法
□ 实现导致关系传播规则
□ 实现实现关系传播规则
□ 实现矛盾关系检测规则
□ 实现依赖关系检查规则
□ 实现可行性评分计算
□ 实现传播触发机制
```

### 10.3 分析模块

```
□ 实现目标-计划树分析
  □ 根目标识别
  □ 依赖树构建
  □ 阻塞点查找
  □ 可执行行动识别
  □ 执行建议生成

□ 实现论证框架分析
  □ 正向证据收集
  □ 负向证据收集
  □ 依赖状态检查
  □ 可行性评分计算
  □ 风险识别
  □ 评估报告生成
```

### 10.4 界面改动

```
□ 更新节点库面板
  □ 更新节点类型列表
  □ 更新节点类型图标和颜色

□ 更新关系选择器
  □ 更新关系类型列表
  □ 更新关系符号和颜色

□ 更新节点编辑面板
  □ 根据节点类型显示不同的状态选项
  □ 假设节点显示置信度滑动条
  □ 所有节点显示影响力滑动条
  □ 约束和结论节点显示自动更新开关
  □ 显示系统分析结果区域

□ 新增分析结果面板
  □ 阻塞点列表
  □ 建议行动列表
  □ 后续步骤列表

□ 更新节点可视化
  □ 基础状态边框颜色
  □ 计算状态图标显示

□ 更新图例
```

---

## 附录：火星场景完整示例

### 节点列表

```
[目标] 活下去
  描述：此刻，我刚从风暴中醒来，腹部插着天线，但我还活着。
  基础状态：notAchieved
  影响力：100%

[目标] 和NASA建立联系
  基础状态：notAchieved
  影响力：70%

[行动] 种植作物
  描述：在栖息舱内开辟农田种植土豆
  基础状态：pending
  影响力：80%

[行动] 修复通讯
  基础状态：pending
  影响力：60%

[行动] 燃烧制水
  基础状态：pending
  影响力：70%

[行动] 制造肥料
  描述：将排泄物与火星土混合，通过翻耕培养细菌
  基础状态：pending
  影响力：60%

[事实] 补给缺口
  描述：食物只够300天，需要活1400天
  基础状态：confirmed
  影响力：90%

[事实] 火星死土
  描述：火星土壤缺乏植物生长必须的细菌和养分
  基础状态：confirmed
  影响力：80%

[事实] 植物学家
  描述：我拥有植物学学位，知道如何让植物生长
  基础状态：confirmed
  影响力：70%

[事实] 没有通讯
  基础状态：confirmed
  影响力：60%

[事实] 氧合机
  描述：栖息舱自带设备，只要有电就能源源不断提供氧气
  基础状态：confirmed
  影响力：50%

[事实] 剩余联氨
  基础状态：confirmed
  影响力：60%

[假设] NASA在监听
  基础状态：uncertain
  置信度：50%
  影响力：60%

[假设] 不会爆炸
  基础状态：positive
  置信度：70%
  影响力：80%

[约束] 热量需求
  描述：必须拥有维持1400天生存的食物总量
  基础状态：unsatisfied
  影响力：100%
  自动更新：开启

[约束] 氧气充足
  基础状态：satisfied
  影响力：100%
  自动更新：开启

[约束] 水源需求
  基础状态：unsatisfied
  影响力：90%
  自动更新：开启

[结论] 没有救援
  基础状态：established
  影响力：70%
  自动更新：开启

[结论] 有通讯能力
  基础状态：notEstablished
  影响力：60%
  自动更新：开启
```

### 关系列表

```
依赖关系：
活下去 --依赖--> 热量需求
活下去 --依赖--> 氧气充足
活下去 --依赖--> 水源需求
种植作物 --依赖--> 水源需求
和NASA建立联系 --依赖--> 有通讯能力
和NASA建立联系 --依赖--> NASA在监听

促成关系：
植物学家 --促成--> 种植作物
氧合机 --促成--> 氧气充足
氧合机 --促成--> 燃烧制水
剩余联氨 --促成--> 燃烧制水
不会爆炸 --促成--> 燃烧制水
和NASA建立联系 --促成--> 活下去
制造肥料 --促成--> 种植作物

阻碍关系：
火星死土 --阻碍--> 种植作物
补给缺口 --阻碍--> 热量需求
没有救援 --阻碍--> 活下去

实现关系：
种植作物 --实现--> 热量需求
燃烧制水 --实现--> 水源需求
修复通讯 --实现--> 和NASA建立联系

导致关系：
没有通讯 --导致--> 没有救援
修复通讯 --导致--> 有通讯能力

矛盾关系：
有通讯能力 --矛盾--> 没有通讯
```

### 分析结果示例

```
目标-计划树分析结果：

根目标：活下去

当前阻塞点：
1. 热量需求 [未满足]
   - 可实现方式：种植作物
   - 种植作物受阻于：水源需求未满足

2. 水源需求 [未满足]
   - 可实现方式：燃烧制水

建议下一步：
▶ 燃烧制水
  - 状态：可立即执行（所有依赖已满足）
  - 效果：满足水源需求
  - 间接效果：解除种植作物的阻塞
  - 风险：依赖假设"不会爆炸"（置信度70%）

执行路径：
1. 燃烧制水 → 水源需求满足
2. 制造肥料 → 提高种植成功率
3. 种植作物 → 热量需求满足
4. 活下去目标可达成

---

论证框架分析结果（评估：种植作物）：

可行性得分：-0.1（低可行性）

正向因素：
+ 植物学家 [事实] 贡献 +0.7
  我拥有植物学学位，知道如何让植物生长

负向因素：
- 火星死土 [事实] 贡献 -0.8
  火星土壤缺乏植物生长必须的细菌和养分

依赖状态：
? 水源需求 [未满足]
  可通过"燃烧制水"解决

风险提示：
1. [高风险] 火星死土是强阻碍因素
   建议：执行"制造肥料"行动改善土壤

2. [中风险] 水源需求尚未满足
   建议：先执行"燃烧制水"

综合评估：
方案可行但有较大挑战。建议先解决水源问题，同时执行制造肥料改善土壤条件。
```
